#! /usr/bin/env bash

source "$DOTFILES_PATH/terminal/core/_main.sh"

##? Dump OCaml AST from file or stdin, works with Reason
##? 0.1.0
##?
##? Usage:
##?    dumpast file.ml
##?    dumpast file.re
##?    dumpast -e "foo(2)"
##?    cat file.ml | dumpast
##?    cat file.re | dumpast --reason

# Create temporary files with proper extensions
temp_ml=$(mktemp).ml
trap "rm -f $temp_ml" EXIT

# Check if input is coming from stdin
if [ -t 0 ]; then
  # Input is from arguments
  if [[ "$1" == *re ]]; then
    cat "$1" > "$temp_ml"
    refmt --parse re --assume-explicit-arity --print ml --in-place "$temp_ml"
    ocamlc -dparsetree "$temp_ml" | sed '1d;2d;$d'
  else
    ocamlc -dparsetree "$@" | sed '1d;2d;$d'
  fi
else
  # Input is from stdin
  if [[ "$1" == "--reason" ]]; then
    temp_re=$(mktemp).re
    trap "rm -f $temp_re $temp_ml" EXIT

    cat > "$temp_re"
    refmt --parse re --assume-explicit-arity --print ml "$temp_re" > "$temp_ml"
    ocamlc -dparsetree "$temp_ml" | sed '1d;2d;$d'
    rm -f "$temp_re"
  else
    cat > "$temp_ml"
    ocamlc -dparsetree "$temp_ml" | sed '1d;2d;$d'
  fi
fi
